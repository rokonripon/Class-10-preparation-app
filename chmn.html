<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶∞‡¶∏‡¶æ‡ßü‡¶® ‡¶®‡ßã‡¶ü</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f0f2f5; margin: 0; padding: 15px; }
        h2 { text-align: center; color: #333; }

        #msg { text-align: center; color: #666; margin-bottom: 15px; font-weight: bold; }

        .chapter-container { margin-bottom: 25px; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .chapter-header { background: #6e8efb; color: white; padding: 12px 15px; font-weight: bold; font-size: 18px; }

        .button-list { display: flex; flex-direction: column; padding: 10px; gap: 10px; }

        .pdf-button {
            background: #fff; border: 1px solid #ddd; color: #333; padding: 15px; 
            border-radius: 8px; font-size: 15px; cursor: pointer; text-align: left;
            display: flex; justify-content: space-between; align-items: center;
            transition: 0.2s;
        }
        .pdf-button:active { background: #f0f0f0; transform: scale(0.98); }
        .status-tag { font-size: 10px; padding: 3px 7px; border-radius: 4px; background: #eee; color: #666; }
        .saved { background: #e8f5e9; color: #2e7d32; font-weight: bold; }

        #viewerOverlay { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #323639; z-index: 9999; flex-direction: column; }
        #toolbar { background: #202124; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        #content-holder { flex: 1; overflow: auto; background: #525659; }

        canvas { display: block; margin: 8px auto; width: 100%; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        iframe { width: 100%; height: 100%; border: none; background: white; }

        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 35px; height: 35px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <h2> ‡¶∞‡¶∏‡¶æ‡ßü‡¶®</h2>
    <div id="msg">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
    <div id="mainContainer"></div>

    <div id="viewerOverlay">
        <div id="toolbar">
            <span id="file-title">‡¶¨‡¶á</span>
            <button onclick="closeViewer()" style="background:#e74c3c; color:white; border:none; padding:7px 15px; border-radius:5px; cursor:pointer;">‡¶¨‡¶®‡ßç‡¶ß</button>
        </div>
        <div id="content-holder"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwgfg9G-vGJO8kVr5r7EnAooshIYhryaIuBFDD7RH0oLhDQ8Ran6LA4pUXdHW7hsE3a/exec";
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';

        let db;
        const request = indexedDB.open("Class8Library", 1);
        request.onupgradeneeded = e => e.target.result.createObjectStore("files", { keyPath: "id" });
        request.onsuccess = e => { db = e.target.result; loadFiles(); };

        async function loadFiles() {
            try {
                const res = await fetch(SCRIPT_URL);
                const files = await res.json();
                organizeByChapters(files);
            } catch (e) {
                const tx = db.transaction("files", "readonly");
                tx.objectStore("files").getAll().onsuccess = (e) => organizeByChapters(e.target.result, true);
            }
        }

        async function organizeByChapters(files, isOffline = false) {
            const mainContainer = document.getElementById('mainContainer');
            mainContainer.innerHTML = "";
            document.getElementById('msg').innerText = isOffline ? "‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® ‡¶Æ‡ßã‡¶°" : "‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶Æ‡ßã‡¶°";

            const chapters = {};
            let hasFiles = false;

            files.forEach(f => {
                // ‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶§‡ßá ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶è‡¶¨‡¶Ç ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ "‡ßÆ‡¶Æ" ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ (Regex)
                const match = f.name.match(/^(\d+)\s*‡¶∞‡¶∏‡¶æ‡ßü‡¶®/);

                if (match) {
                    hasFiles = true;
                    const chNum = match[1];
                    const chName = "‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º: " + chNum;
                    if (!chapters[chName]) chapters[chName] = [];
                    chapters[chName].push(f);
                }
            });

            if (!hasFiles) {
                mainContainer.innerHTML = "<p style='text-align:center; color:red;'>‡¶ï‡ßã‡¶®‡ßã ‡¶´‡¶æ‡¶á‡¶≤ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!</p>";
                return;
            }

            for (const ch in chapters) {
                const section = document.createElement('div');
                section.className = 'chapter-container';
                section.innerHTML = `<div class="chapter-header">${ch}</div>`;

                const list = document.createElement('div');
                list.className = 'button-list';

                for (const f of chapters[ch]) {
                    const saved = await getFromDB(f.id);
                    // ‡¶è‡¶ï‡ßç‡¶∏‡¶ü‡ßá‡¶®‡¶∂‡¶® (.pdf ‡¶¨‡¶æ .html) ‡¶∞‡¶ø‡¶Æ‡ßÅ‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
                    const displayName = f.name.replace(/\.(pdf|html)$/i, "");

                    const btn = document.createElement('button');
                    btn.className = 'pdf-button';
                    btn.innerHTML = `<span>${f.type === 'pdf' ? 'üìÑ' : 'üåê'} ${displayName}</span> 
                                     <span class="status-tag ${saved ? 'saved' : ''}">${saved ? '‡¶´‡ßã‡¶®‡ßá ‡¶Ü‡¶õ‡ßá' : '‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°'}</span>`;
                    btn.onclick = () => handleAction(f);
                    list.appendChild(btn);
                }
                section.appendChild(list);
                mainContainer.appendChild(section);
            }
        }

        async function handleAction(file) {
            const saved = await getFromDB(file.id);
            const cleanTitle = file.name.replace(/\.(pdf|html)$/i, "");

            if (saved) {
                openFile(saved.data, cleanTitle, file.type);
            } else {
                document.getElementById('msg').innerText = "‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
                try {
                    const res = await fetch(`${SCRIPT_URL}?fileId=${file.id}`);
                    const base64 = await res.text();
                    saveToDB(file.id, file.name, base64, file.type);
                    openFile(base64, cleanTitle, file.type);
                } catch (e) { alert("‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•!"); }
            }
        }

        function saveToDB(id, name, data, type) {
            const tx = db.transaction("files", "readwrite");
            tx.objectStore("files").put({ id, name, data, type });
            loadFiles();
        }

        function getFromDB(id) {
            return new Promise(r => {
                const tx = db.transaction("files", "readonly");
                const req = tx.objectStore("files").get(id);
                req.onsuccess = () => r(req.result);
            });
        }

        function openFile(base64, name, type) {
            document.getElementById('viewerOverlay').style.display = 'flex';
            document.getElementById('file-title').innerText = name;
            const holder = document.getElementById('content-holder');
            holder.innerHTML = '<div class="loader"></div>';

            if (type === 'pdf') {
                renderPDF(base64, holder);
            } else {
                renderHTML(base64, holder);
            }
        }

        async function renderPDF(base64, holder) {
            try {
                const pdfData = atob(base64);
                const pdf = await pdfjsLib.getDocument({data: pdfData}).promise;
                holder.innerHTML = "";
                const dpr = window.devicePixelRatio || 1;

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: window.innerWidth / page.getViewport({scale:1}).width });
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.width = Math.floor(viewport.width * dpr);
                    canvas.height = Math.floor(viewport.height * dpr);
                    canvas.style.width = "100%";
                    await page.render({ canvasContext: context, viewport, transform: [dpr, 0, 0, dpr, 0, 0] }).promise;
                    holder.appendChild(canvas);
                }
            } catch(e) { holder.innerHTML = "<p style='color:white;text-align:center;'>PDF ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá</p>"; }
        }

        function renderHTML(base64, holder) {
            const htmlCode = decodeURIComponent(escape(atob(base64)));
            holder.innerHTML = `<iframe id="htmlViewer"></iframe>`;
            const iframe = document.getElementById('htmlViewer');
            const doc = iframe.contentWindow.document;
            doc.open(); doc.write(htmlCode); doc.close();
        }

        function closeViewer() {
            document.getElementById('viewerOverlay').style.display = 'none';
            document.getElementById('content-holder').innerHTML = "";
            document.getElementById('msg').innerText = "‡ßÆ‡¶Æ ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø ‡¶≤‡¶æ‡¶á‡¶¨‡ßç‡¶∞‡ßá‡¶∞‡¶ø";
        }
    </script>
</body>
</html>